
================== Installing WebGUI 8 on the WRE ====================

The WRE is the "WebGUI Runtime Environment".  It packages up a MySQL,
Perl, and most of the Perl modules WebGUI needs to run.

This document attempts to combine the install instructions that come
with wG8 with the instructions that come with the WRE to create a
single, coherent set of install instructions.

======================================================================

1. Get the latest WRE for your OS and unpack the WRE archive

Get the WRE from sourceforge.net.  Go to this URL and pick out the latest
version for your OS:

   http://sourceforge.net/projects/pbwebgui/files/WebGUI%20Runtime%20Environment/

At the time of this writing, WRE-0.9.6 is the latest.

Then do:

  $ mkdir /data
  $ cd /data
  $ tar xvfz /path/to/wre-x.x.x-osname.tar.gz

wG8 doesn't have to go into the "/data" directory as 7 preferred to.  You may
substitute whichever other directory you prefer whereever "/data" appears in
these docs.

2. Get WebGUI8 from GitHub:

  $ cd /data
  $ git clone https://github.com/plainblack/webgui.git WebGUI


3. Add a "webgui" user to the system. Note that you can name this
user whatever you want, but we recommend "webgui". On most systems
you run a command similar to the following as the root user:

  # adduser -s /sbin/nologin webgui
            - or -
  # useradd -s /sbin/nologin webgui

NOTE: If you're just using the WRE for development on your machine, feel free
to just use your own user account rather than creating a new one.


4. Shut down httpd and mysql if they are installed but not used

If you have an existing Apache or MySQL running that you aren't using,
please shut them down now.

If you are using MySQL, then *stop*.  Do not use the WRE on this system.
Do the "source install" process, but use the existing MySQL, creating
a new database and user on it.

If you are using the existing httpd, proceed, but do not kill it.
WebGUI will have to listen on a different port and the existing httpd
will have be configured to proxy to it, or else WebGUI will have to be
set to listen on a different IP address.  Consult your httpd's manual
for further instructions.

On most systems you can shut them down hard by running commands like this:

  #  killall mysqld
  #  killall httpd

If you have a MySQL config file at /etc/my.cnf please remove or rename it so
that it doesn't interfere with the WRE MySQL.

  $ mv /etc/my.cnf /etc/my.cnf.old

Remove them from your operating system's startup.  FIXME:  provide details
or a reference.

FIXME:  WRE mysql should be patched to not look in /etc/.


6. Initialize MySQL, set a MySQL root password and create a MySQL "webgui"
   account

Make sure that you're initializing database in the WRE, not another one.

  $ which mysql_install_d

That should output "/data/wre/prereqs/bin/mysql_install_db"

  $ mysql_install_db --user=webgui

That sets mysql to run as the "webgui" user previously created.

Start the mysqld server daemon:

  $ sudo mysqld_safe --user=webgui &

Get into the mysql command shell:

  $ mysql --user=root

Set the root users (plural!) passwords:

  mysql> SET PASSWORD FOR 'root' = PASSWORD('XXXnewpasswdXXX');
  mysql> SET PASSWORD FOR 'root'@'localhost' = PASSWORD('XXXnewpasswdXXX');
  mysql> SET PASSWORD FOR 'root'@'127.0.0.1' = PASSWORD('XXXnewpasswdXXX');

Or else drop root users you don't want.

Remember the password!  You have to put it in your WebGUI's config file in a 
few steps here.  FIXME:  Does one of the site-setup tools that comes with the
WRE do this for you?

Pick your own password instead of "XXXnewpasswdXXX".

Get rid of the anonymous user:

  mysql> drop user '';

Leave in the test user and database, as they're needed for the WRE to see if
mysql is up and running.


7. Create a MySQL user account for the domain WebGUI is to host
and load share/create.sql into that database

Pick a database name.  The practice is to name it after the site.  If you're
hosting www.example.com, then "www_example_com" is a good database name
for the site, and the config file will be 
"/data/WebGUI/etc/www.example.com.conf".

Create the new, empty database.  Change "www_example_com" here to whatever 
yours is.

  $ mysql --password --user=root --password -e "create database www_example_com"

Create the 'webgui' database user and set its password:

  $ mysql --password --user=root -e "grant all privileges on www_example_com.*
        to webgui@localhost identified by 'XXXXpasswordhereXXXX'"

Load the database:

  $ mysql --password --user=webgui www_example_com < share/create.sql

That may not work.  Newer versions of MySQL will give you "ERROR 1064 (42000)
at line 19: You have an error in your SQL syntax; check the manual that
corresponds to your MySQL server version for the right syntax to use near
'TYPE=InnoDB CHARSET=utf8' at line 14".  If so, do this instead:

  $ cat share/create.sql | \
    sed -e 's!^) TYPE=\([A-Za-z]*\) CHARSET=utf8;$!) ENGINE=\1 CHARSET=utf8;!' | \
    mysql --user=webgui --password www_example_com

FIXME:  Future versions of share/create.sql will target MySQL 5.5.


8. Use the WRE environment

    source /data/wre/sbin/setenvironment.sh  

NOTE: You could add that command to your profile so it
executes every time you log in. However, on CentOS 5 servers
this can interfere with yum running.

You must always run this command before interacting with WebGUI using any
command line utilities -- running upgrades, editing assets, starting and
stopping wG related services and other things all require this.


9. Setup your configuration files

Copy /data/WebGUI/etc/WebGUI.conf.original to something named after the site's 
URL and ending in .conf, such as www.example.com.conf, and edit it, making sure
to insert your site's URL and the database connection information.

These are the dbuser, dbpass, and dsn keys, as well as the uploadsPath.  

Set uploadsPath in the .conf file to eg 
/data/domains/www.example.com/public/uploads/.

This file is JSON formatted and may not have trailing commas after the last 
item in a list (FIXME:	use JSON relaxed).

If you're running WebGUI on a port other than 80, edit "etc/spectre.conf" to define port and worker settings for spectre.  


10. Customize the WRE configuration file with database users, paths and other items.

    vim /data/wre/etc/wre.conf


11. Setup your environment

Set the WEBGUI_CONFIG environment variable to point at your new configuration file:

  $ export WEBGUI_CONFIG='/data/WebGUI/etc/www.example.com.conf'

You may want to set your shell to automatically do that for you by putting that command into your .bashrc file in your home directory.


12. Add WebGUI's libraries to Perl's library path:

  $ export PERL5LIB='/data/WebGUI/lib:/data/WebGUI/t/lib'

Previously, this would break Apache if it were set; now it's required for the
stuff plackup loads to find the rest of WebGUI.

This should probably go into your .bashrc, too.


13. Automatically install new Perl module dependencies:

  $ sudo bash   
  #  source /data/wre/sbin/setenvironment.sh
  # export WEBGUI_CONFIG='/data/WebGUI/etc/www.example.com.conf'
  # sbin/testEnvironment.pl

FIXME:  testEnvironment shouldn't insist on being root when the current user can actually write to the perl libs directories in the wre.


14. Initialize your /data/domains/www.example.com/public directory with static content

  wgd reset --uploads


15. Run the WRE setup script to create base templates for nginx, logrotate and Spectre

    /data/wre/sbin/wresetup.pl

16. Run upgrades!  Important!


17. Add the following cron jobs to your server's cron tab.

  0 0 * * * /data/wre/sbin/logrotate.pl
  */3 * * * * /data/wre/sbin/wremonitor.pl
  0 2 * * * /data/wre/sbin/backup.pl

If you are using the demo system then add this:

  0 0 * * * /data/wre/sbin/democleanup.pl


18. Update the wgd WebGUI Developer's Utility:

WebGUI has a new upgrades system for wgd to support. The old system silently
ignores the new upgrade scripts.

Get wgd from http://haarg.org/wgd, put in /data/wre/prereqs/bin/ (if you're
using the WRE), /usr/local/bin, or ~/bin.

Do chmod ugo+x wgd to make it executable.

   $ wget http://haarg.org/wgd -O wgd
   $ sudo chmod ugo+x wgd
   $ sudo mv wgd /data/wre/prereqs/bin/


19. Run Upgrades:

This is needed even for new WebGUI 8 installs. The create.sql and
WebGUI.conf.original are both from 7.10.x.

  $ wgd reset --upgrade


20. Copy new "extras" (images, CSS, JavaScript) over:

  $ rsync -r -a (or cp -a) /data/WebGUI/www/extras \
        /data/domains/www.example.com/public/


21. Launch WebGUI 8:

In /data/WebGUI:

  $ plackup app.psgi

... then connect your browser to the URL it advertises.

You'll be guided through a few quick questions to setup an admin account.
(Or, if you aren't but wanted to be, run wgd reset --starter to enable it.)
 

22. Start Spectre:

Spectre is the background processing daemon that runs workflows you configure
or are already configured which do things like deliver email, clean out the
trash, and so on.

  $ cd /data/WebGUI/sbin
  $ perl spectre.pl --daemon




PLATFORM SPECIFIC NOTES
-----------------------

* Red Hat Linux

This note applies to all linux' that use chkconfig to setup services. These
include RHEL, Fedora, Mandrake, SuSE, CentOS, and others. You can set up the
WRE to start automatically at system boot by running the following commands
after the WRE is installed:

ln -s /data/wre/sbin/services/redhat/webgui /etc/init.d/webgui
chkconfig --add webgui
chkconfig webgui on

On RHEL 5 or higher you need to install the libgomp RPM.

Installing Percona via yum:

rpm -Uhv http://www.percona.com/downloads/percona-release/percona-release-0.0-1.i386.rpm
yum install -y Percona-Server-{server,client,shared,devel}-55


* SELinux

The WRE contains no policies for configuring SELinux. If you distribution
uses SELinux, you will need to disable it, set it into permissive mode,
or write your own policies for SELinux.


* Mac OS X

There is no command line user add script on Mac OSX. Therefore you can either
use the graphical "Accounts" manager in "System Preferences", or the really
horrible "netinfo" command line utility. Alternatively, you can also download
some free user utilities from this site:

http://www.osxgnu.org/software/pkgdetail.html?project_id=231#4095

To get the WRE to start automatically at boot run the following commands:

ln -s /data/wre/sbin/services/osx/org.webgui.wre.plist /Library/LaunchDaemons/
